(function(f){var g=[];var e=function(h){return a(h)||d(h)};var a=function(h){return h.hasClass("icon-stop-watching")};var d=function(h){return h.hasClass("link-stop-watching")};var c=function(j,l,k){var i=e(k),o=a(k),m=k.parent().find(".icon-wait"),h,n;if(l=="page"){h=Confluence.getContextPath()+"/users/"+(i?"removepagenotificationajax.action":"addpagenotificationajax.action");n={pageId:j}}if(l=="space"){h=Confluence.getContextPath()+"/users/"+(i?"removespacenotificationajax.action":"addspacenotificationajax.action");n={spaceKey:j}}k.addClass("hidden");m.removeClass("hidden");AJS.safe.ajax({url:h,type:"POST",data:n,success:function(p){AJS.log(p);m.addClass("hidden");if(o){k.parent().find(i?".icon-start-watching":".icon-stop-watching").removeClass("hidden")}else{k.parent().find(i?".link-start-watching":".link-stop-watching").removeClass("hidden")}delete g[j]},error:function(r,q,p){m.addClass("hidden");if(o){k.parent().find(i?".icon-start-watching":".icon-stop-watching").removeClass("hidden")}else{k.parent().find(i?".link-start-watching":".link-stop-watching").removeClass("hidden")}AJS.log("Error Toggling Watching: "+q);delete g[j]}})};var b=function(i,h){if(i.attr("data-watching-bound")){return}i.delegate(".icon-start-watching, .icon-stop-watching, .link-start-watching, .link-stop-watching","click",function(m){var k=f(m.target);var j,l=i.attr("data-entity-type");if(h&&h.getEntityId&&typeof h.getEntityId=="function"){j=h.getEntityId(k)}else{j=i.attr("data-entity-id")}if(g[j]){AJS.log("Already busy toggling favourite for "+l+" '"+j+"'. Ignoring request.");return}g[j]=true;c(j,l,k);return false});i.attr("data-watching-bound",true)};AJS.Confluence.Binder.watching=function(){f(".entity-watching").each(function(){if(!f(this).attr("data-watching-bound")){b(f(this),{})}})};f.fn.watching=function(h){f(this).each(function(){var i=f(this);b(i,h)})}})(AJS.$);