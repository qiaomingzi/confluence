AJS.Labels=(function(f){var n=function(){var r=0;if(AJS.Meta.get("num-labels")){r=AJS.Meta.get("num-labels")}else{if(f("#createPageLabelsString").val()){r=f.trim(f("#createPageLabelsString").val()).split(/\s+/).length}}if(r!=0){AJS.Meta.set("num-labels",r);f("#rte-button-labels").trigger("updateLabel")}};AJS.bind("init.rte-control",n);var c=function(r){r=AJS.$.trim(r);if(!r){return[]}var s=[];var t=new Date().getTime();f(r.split(/\s+/)).each(function(w,y){var v=y.split(":"),x,u=v[0];if(v.length===2){x=v[0];u=v[1]}s.push({name:u,prefix:x,id:t});t++});return s};var e={labelView:".label-list",labelItem:".aui-label",noLabelsMessage:".no-labels-message",idAttribute:"data-label-id",labelsFormFieldId:AJS.Meta.get("labels-form-field-id")||"createPageLabelsString"};var q=Confluence.getContextPath();var o={base:q+"/rest/ui/1.0/",getRestEndPoint:function(r){var s=(r=="attachment")?"attachment/":(r=="template")?"template/":(r=="space")?"space/":"content/";return this.base+s},index:q+"/labels/autocompletelabel.action?maxResults=3",validate:function(){return this.getRestEndPoint()+"labels/validate"},add:function(s,r){return this.getRestEndPoint(s)+r+"/labels"},remove:function(s,r,t){return this.getRestEndPoint(s)+r+"/label/"+t},list:function(s,r){return this.getRestEndPoint(s)+r+"/labels"}};var j=function(){return !!document.getElementById("createpageform")||!!document.getElementById("createpagetemplate")};var a=function(){return f(".space-administration").length};function i(r,u){if(!(r&&u)){var s=f("#dialog-label-list");r=s.attr("entityid");u=s.attr("entitytype")}if(!(r&&u)){return f(e.labelView)}var t=f(".labels-section-content").filter(function(){return this.getAttribute("entityid")==r&&this.getAttribute("entitytype")==u});return t.find(e.labelView)}var m=function(r){p();if(r&&r.promise){r.always([l,h]);r.done(function(u,t){AJS.Meta.set("num-labels",i().first().find(e.labelItem).size());f("#rte-button-labels").trigger("updateLabel");var s=t.not(".editable");if(t.find(".aui-label").length===0){s.find(".labels-edit-container").before(Confluence.Templates.Labels.nolabels())}else{s.find(".no-labels-message").remove()}})}return r};var b=function(){f("#labels-string, #add-labels-editor-button").attr({disabled:"disabled","aria-disabled":true})};var h=function(){f("#labels-string, #add-labels-editor-button").removeAttr("disabled aria-disabled")};var l=function(){f("#labels-string").val("")};var p=function(s){s=s||null;var r="#label-operation-error-message";f(r).empty().toggle(!!s);AJS.messages.warning(r,{body:s})};var k=function(s,x,v){if(!s){return false}b();var t=f("#"+e.labelsFormFieldId);if(j()){var A=(t.val()+" "+s).split(/\s+/);var u=[];AJS.$.each(A,function(C,B){if(u.indexOf(B)===-1){u.push(B)}});s=u.join(" ")}var z=c(s);var w={url:j()?o.validate():o.add(v,x),type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(z)},r,y=f.Deferred();r=AJS.$.ajax(w);r.done(function(E){var D=f("#dialog-label-list").find(".label-list"),C=i(x,v).not(".editable"),B=E.labels;if(j()){t.val(s);var F=new Date().getTime();AJS.$.each(B,function(H,G){G.id=F++});D.empty()}D.html(Confluence.Templates.Labels.labels({labels:B,spaceKey:AJS.Meta.get("space-key"),editable:true}));C.find("li.aui-label").remove();C.find("li.labels-edit-container").before(Confluence.Templates.Labels.labels({labels:B,spaceKey:AJS.Meta.get("space-key")}));y.resolve(B,C.add(D))});r.fail(function(E,B){var C;if(B==="timeout"){C=AJS.I18n.getText("xhr.timeout")}else{try{C=JSON.parse(E.responseText).message}catch(D){C=B;AJS.log("Unexpected error when adding labels: "+D.message)}}AJS.log("Failed to add labels: "+C);AJS.log("Failed to add labels xhr: "+E.responseText);p(C);y.reject(B)});return y.promise()};var d=function(t,s,w){if(!t){return false}t=t.jquery?t:f(t);if(a()){s=AJS.Meta.get("space-key");w="space"}var y=t.attr(e.idAttribute),r=f.trim(t.find("a").text()),x,v={type:"DELETE",dataType:"json",contentType:"application/json",data:{}},u=f.Deferred();if(j()){x=f.Deferred();x.resolve()}else{v.url=o.remove(w,s,y);x=AJS.$.ajax(v)}x.done(function(){var A=i(s,w);if(a()){A=f("#space-categories-list")}var z=A.find(e.labelItem);var B=z.filter("["+e.idAttribute+"='"+y+"']");B.fadeOut("normal",function(){B.remove();u.resolve(t,A)})});x.fail(function(A,z){AJS.log(z);p(z=="timeout"?AJS.I18n.getText("xhr.timeout"):z);u.reject(z)});j()&&u.done(function(){var z=f("#"+e.labelsFormFieldId);var A=z.val();var B=A.split(/\s+/);B=f.grep(B,function(C){return(!C||C==r)},true);z.val(B.join(" "))});return u.promise()};var g=function(){var w=f("#labels-string"),v=w.parents("#add-labels-form").length;if(!w.length){return}var t=function(x){f("#labels-autocomplete-list").append(x)};var u=function(F){if(F.find("a.label-suggestion").length){var G=f("span",F),C=f.data(G[0],"properties"),E=w.val(),y=[];if(v){y=E.split(/\s+/);y[y.length-1]=C.name;w.val(y.join(" "))}else{var D=AJS.Labels.queryTokens,J=-1,z,A="";for(var B=0,I=D.length;B<I;B++){A=D[B];z=E.lastIndexOf(A);if(z>J){J=z}}if(J!=-1){var H=E.substr(0,J);var x=E.substr(J+A.length).match(/^\s+/);if(x){H+=x[0]}w.val(H+C.name)}else{w.val(C.name)}}}};var r=function(){if(!f("#labels-autocomplete-list .label-suggestion").length||w.val()===""){this.hide()}else{if(!v){var z=f("#labels-autocomplete-list a.label-suggestion");for(var x=0,y=z.length;x<y;x++){z.get(x).href="#"}}}};var s="/labels/autocompletelabel.action?maxResults=3";f(window).bind("quicksearch.ajax-success",function(y,x){if(x.url==s){AJS.Labels.queryTokens=(x.json&&x.json.queryTokens)||[];return false}});f(window).bind("quicksearch.ajax-error",function(y,x){if(x.url==s){AJS.Labels.queryTokens=[];return false}});w.quicksearch(s,r,{makeParams:function(x){return{query:x,contentId:AJS.params.pageId||""}},dropdownPlacement:t,ajsDropDownOptions:{selectionHandler:function(y,x){u(x);this.hide();y.preventDefault()}}})};f(".label-list.editable .aui-icon-close").live("click",function(s){s.preventDefault();var r=f("#dialog-label-list");AJS.Labels.removeLabel(f(this).closest("li"),r.attr("entityid"),r.attr("entitytype"))});AJS.toInit(function(){if(a()){AJS.Labels.bindAutocomplete();f(".label-list").addClass("editable")}});return{addLabel:function(s,r,t){return m(k(s,r,t))},removeLabel:function(s,r,t){return m(d(s,r,t))},bindAutocomplete:g,isNewPage:j,routes:o,setLabelError:p,parseLabelStringToArray:c}})(AJS.$);