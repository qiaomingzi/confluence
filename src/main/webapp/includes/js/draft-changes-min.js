AJS.toInit(function(e){AJS.log("draft-changes initialising");var a,f;var h=function(j){a=new AJS.Dialog(860,530,"view-diff-draft-dialog");var k=AJS.I18n.getText("draft.heading");a.addHeader(k.replace(/\{0\}/,""));var i=e(Confluence.Templates.DraftChanges.dialogContent());a.addPanel("Diff",i);if(j){a.addButton(AJS.I18n.getText("edit.name"),function(l){a.hide();if(Confluence.Editor&&Confluence.Editor.Drafts){Confluence.Editor.Drafts.useDraft()}else{window.location=e(this).attr("data-href")}},"resume-diff-link");a.addButton(AJS.I18n.getText("discard.name"),function(m){if(Confluence.Editor&&Confluence.Editor.Drafts){a.hide();Confluence.Editor.Drafts.discardDraft(AJS.Meta.get("existing-draft-id"))}else{var l=e(this).data("draftid");if(c(l)){a.hide()}}},"discard-diff-link")}a.addCancel(AJS.I18n.getText("close.name"),function(){a.hide();return false});i.removeClass("hidden")};var d=function(l,j){e("#diff-view").html(l.htmlDiff);var m=AJS.I18n.getText("draft.heading",AJS.escapeHtml(l.title));a.addHeader(m);a.popup.element.find(".dialog-title").prepend(Confluence.Templates.DraftChanges.helpLink());var k=e("#atlassian-token").attr("content");var i=Confluence.getContextPath();e(".resume-diff-link").attr("data-href",i+"/pages/resumedraft.action?draftId="+j);e(".discard-diff-link").data("draftid",j);AJS.setVisible("#merge-warning",l.isMergeRequired)};var g=function(k){var i,m,j;var l=function(o){var n=/draftPageId:([^ ]*)/.exec(o);i=n?n[1]:AJS.Meta.get("page-id");n=/username:([^ ]*)/.exec(o);m=n?n[1]:AJS.Meta.get("remote-user");n=/draftId:([^ ]*)/.exec(o);j=n?n[1]:null};l(k.attr("class"));AJS.safeAjax({url:Confluence.getContextPath()+"/draftchanges/viewdraftchanges.action",type:"GET",dataType:"json",data:{pageId:i,username:m},success:function(p){if(p.actionErrors){var o="";var q=p.actionErrors;for(var n=0;n<q.length;n++){AJS.log("error: "+(q[n]));o=o+"<div>"+q[n]+"</div>"}e("#diff-view").html(o)}else{d(p,j)}},error:function(n){var o=n.errors||"An unknown error has occurred. Please check your logs";e("#diff-view").html(o)}})};var b=function(j,i){if(!a){h(i)}a.addHeader(AJS.I18n.getText("loading.name"));e("#diff-view").html("<tr><td id='draft-changes-waiting-icon'>Loading...</td></tr>");g(j);a.show()};e("body").on("click","#draft-status .view-diff-link",function(i){b(e(this),false);return AJS.stopEvent(i)});e("body").on("click","#draft-messages .view-diff-link",function(i){b(e(this),true);return AJS.stopEvent(i)});e("#draft-space-list").on("click",".view-diff-link",function(i){b(e(this),true);return AJS.stopEvent(i)});var c=function(i){var j=AJS.I18n.getText("discard.draft.confirmation");if(confirm(j)){AJS.safeAjax({url:Confluence.getContextPath()+"/json/deletedraft.action",type:"GET",dataType:"json",data:{draftId:i},success:function(o){if(o.actionErrors){var n=["<ul>"],q=o.actionErrors;for(var m=0;m<q.length;m++){AJS.log("error: "+(q[m]));n.push("<li>"+q[m]+"</li>")}n.push("</ul>");AJS.messages.error("#errors",{title:AJS.I18n.getText("discard.draft.error.title"),body:AJS.I18n.getText("draft.saving.error.could.not.delete")+" "+n.join("\n")})}else{var k=e("#draft-"+i);var l=k.closest("table");var p=l.closest(".drafts-container");k.remove();if(l.find("tbody tr").length==0){p.append('<span id="no-drafts-message">'+AJS.I18n.getText("no.drafts.found")+"</span>")}}},error:function(k){AJS.messages.error({title:"Error",body:k.errors||AJS.I18n.getText("discard.draft.unknown.error")})}});return true}return false};e(".discard-draft-link").click(function(j){j.preventDefault();var i=e(this).data("draftid");c(i)})});