AJS.toInit(function(e){var c,f=140;function b(){var n="idontthinksohal";var k=new AJS.Dialog(650,n,"update-user-status-dialog");var m=k.popup.element;var l=e(Confluence.Templates.UserStatus.dialogContent({maxChars:f}));k.addHeader(AJS.I18n.getText("status.dialog.heading"));k.addPanel(AJS.I18n.getText("status.dialog.panel.title"),l);k.addButton(AJS.I18n.getText("status.dialog.button.update"),i,"status-update-button");k.addCancel(AJS.I18n.getText("cancel.name"),function(o){o.hide();return false});k.setError=function(o){e(".error-message",m).html(o)};return k}function h(l){var k;if(!l){k=AJS.I18n.getText("status.message.error.blank")}else{if(!e.trim(l)){k=AJS.I18n.getText("status.message.error.onlywhitespace")}else{if(l.length>f){k=AJS.I18n.getText("status.message.error.too.long",f)}}}if(k){c.setError(k)}return !k}function d(k){e(".current-user-latest-status .status-text").html(k.text);e(".current-user-latest-status a[id^=view]").each(function(){var m=e(this),l=m.attr("href");m.attr("href",l.replace(/\d+$/,k.id)).text(k.friendlyDate).attr("title",new Date(k.date).toLocaleString())})}function j(){e.getJSON(Confluence.getContextPath()+"/status/current.action",function(k){if(k.errorMessage){c.setError(k.errorMessage)}else{d(k)}})}var i=function(){var n=c.popup.element,q=e("#status-text",n),l=e(".status-update-button",n),p=q.val(),k,o;function m(){q.blur();q.prop("disabled",true).prop("readonly",true);l.prop("disabled",true);return function(){try{q.focus()}catch(r){}q.prop("disabled",false).prop("readonly",false);l.prop("disabled",false)}}k=m();if(!h(p)){k();return false}o=AJS.safe.ajax({url:Confluence.getContextPath()+"/status/update.action",type:"POST",dataType:"json",data:{text:p}});o.done(k).fail(k);o.done(function(r){if(r.errorMessage){c.setError(r.errorMessage)}else{d(r);q.val("");n.fadeOut(200,function(){c.hide()})}});o.fail(function(t,s,r){AJS.log("Error updating status: "+s);AJS.log(r);c.setError("There was an error - "+r)});return o.promise()};var a=function(k){var m=k.popup.element,o=e("#status-text",m),n=e(".chars-left",m),l=e(".status-update-button",m);o.keydown(function(p){if(p.keyCode==13){i()}}).bind("blur focus change "+(!e.browser.msie?"paste input":"keyup"),function(){var q=e(this).val(),p=f-q.length;l.prop("disabled",!q.length);n.text(Math.abs(p)).toggleClass("close-to-limit",p<20).toggleClass("over-limit",p<0)});e("form",m).submit(function(p){p.preventDefault();i()})};var g="#create-user-status-link";e(g).click(function(l){var k=e(this).parents(".ajs-drop-down")[0];k&&k.hide();if(typeof c=="undefined"){c=b();a(c)}j();c.setError("");c.show();e("#update-user-status-dialog #status-text").prop("readonly",false).prop("disabled",false).focus();return AJS.stopEvent(l)})});