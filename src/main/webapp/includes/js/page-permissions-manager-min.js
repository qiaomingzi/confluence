AJS.PagePermissions=AJS.PagePermissions||{};AJS.toInit(function(e){var h="user",s="group";var j=Confluence.getContextPath();var n=function(){return e("#rte-button-restrictions").parent().is(":visible")};var a=null;var k=null;var q=null;var m={addNames:function(v,x){var w=this;var u=v.replace(/\s*,\s*/g,",").split(",");var y=e("#waitImage");y.show();var z={name:u,type:x||"",pageId:AJS.Meta.get("parent-page-id"),spaceKey:AJS.Meta.get("space-key")};e.getJSON(j+"/pages/getentities.action",z,function(E){y.hide();for(var D=0,A=E.length;D<A;D++){var B=E[D].entity;w.addEntity(E[D]);var C=e.inArray(B.name,u);u.splice(C,1)}k.validator.handleNonExistentEntityNames(u)})},addEntity:function(w){if(!w){return}var v=w.entity;var u=w.report;var y=k.getPermissionType();if(k.validator.isDuplicateEntityForType(v,y)){q.highlightEntityRow(v,y);return}var x={entity:v,view:true,edit:true,report:u};q.addRow(x,y);Confluence.Binder.userHover();q.changedByUser();q.highlightEntityRow(v,y);k.nameField.removeFromNameInput(v.name)},makePermissionStrings:function(){var u=q.makePermissionMap(false);return{viewPermissionsUsers:u.user.view.join(","),editPermissionsUsers:u.user.edit.join(","),viewPermissionsGroups:u.group.view.join(","),editPermissionsGroups:u.group.edit.join(",")}}};e.extend(AJS.PagePermissions,{addUserPermissions:function(u){m.addNames(u,h)},addGroupPermissions:function(u){m.addNames(u,s)},makePermissionStrings:m.makePermissionStrings,updateEditPageRestrictions:d});function f(w){q.allowEditing(w.userCanEditRestrictions);q.resetInherited();if(!m.permissionsEdited){q.resetDirect()}if(!w){return}for(var x=0,z=w.permissions.length;x<z;x++){var F=w.permissions[x];var B=F[0].toLowerCase();var u=F[1];var D=F[2];var v=(u==h)?w.users[D]:w.groups[D];var E=F[3];var C=F[4];var y=+E&&E!=AJS.params.pageId;if(m.permissionsEdited&&!y){continue}var A={owningId:E,entity:v.entity,report:v.report};A[B]=true;A.owningTitle=C;A.inherited=y;q.addRow(A,B)}if(w.permissions.length>0){Confluence.Binder.userHover()}q.saveBackup();q.refresh()}function d(){var A=q.makePermissionMap(false),x=e("#rte-button-restrictions"),B=x.find(".icon"),D=x.find(".trigger-text"),w=[].concat(A.group.view).concat(A.user.view).concat(A.group.edit).concat(A.user.edit),u=e("#page-inherited-permissions-table-desc:visible"),z="icon-restricted icon-restricted-inherited icon-unrestricted";if(w.length||u.length){var E=w.length?"icon-restricted":"icon-restricted-inherited";B.removeClass(z).addClass(E);D.text(AJS.I18n.getText("page.restrictions.restricted"))}else{B.removeClass(z).addClass("icon-unrestricted");D.text(AJS.I18n.getText("page.restrictions.none"))}m.permissionsEdited=false;var y=m.makePermissionStrings();for(var C in y){var v=y[C];e("#"+C).val(v);if(m.originalPermissions[C]!=v){m.permissionsEdited=true}}}function p(){k.validator.resetValidationErrors();q.clearHighlight();a.hide();window.scrollTo(m.bookmark.scrollX,m.bookmark.scrollY)}function g(){var v=e(".permissions-update-button").disable();if(n()){d();v.enable();p()}else{var u=m.makePermissionStrings();u.pageId=AJS.params.pageId;e("#waitImage").show();AJS.safe.post(j+"/pages/setpagepermissions.action",u,function(w){e("#waitImage").hide();AJS.trigger("system-content-metadata.toggled-restrictions",{hasRestrictions:w.hasPermissions});v.enable();p()},"json")}}function c(){p();if(n()){q.restoreBackup()}return false}function o(){a=AJS.ConfluenceDialog({width:840,height:530,id:"update-page-restrictions-dialog",onCancel:c});a.addHeader(AJS.I18n.getText("page.perms.dialog.heading"));a.addPanel("Page Permissions Editor",AJS.renderTemplate("page-permissions-div"));a.addButton(AJS.I18n.getText("update.name"),g,"permissions-update-button");a.addCancel(AJS.I18n.getText("close.name"),c);a.popup.element.find(".dialog-title").prepend(Confluence.Templates.PagePermissions.helpLink());k=AJS.PagePermissions.Controls(m);var u=e("#page-permissions-table").bind("changed",r);q=AJS.PagePermissions.Table(u);m.table=q}function i(u){m.bookmark={scrollX:document.documentElement.scrollLeft,scrollY:document.documentElement.scrollTop};b();k.setVisible(u.userCanEditRestrictions);AJS.setVisible(".permissions-update-button",u.userCanEditRestrictions);a.show()}function t(z,w){if(!m.originalPermissions&&n()){m.originalPermissions=Confluence.Editor.getPagePermissions()}var x=(w&&e("#newSpaceKey").val())||AJS.Meta.get("space-key");var u=(w&&e("#parentPageString").val())||"";var y={pageId:AJS.Meta.get("page-id"),parentPageId:AJS.Meta.get("parent-page-id"),parentPageTitle:u,spaceKey:x};var v;if(AJS.params.newPage){y.draftId=AJS.Meta.get("content-id")}e("#waitImage").show();if(n()){v=j+"/pages/geteditpagepermissions.action";e.extend(y,Confluence.Editor.getPagePermissions())}else{v=j+"/pages/getpagepermissions.action"}e.getJSON(v,y,function(A){e("#waitImage").hide();f(A);z(A)})}function l(u){a||o();t(i,u)}function r(){e(".permissions-update-button").enable();e(".button-panel-cancel-link").text(AJS.I18n.getText("cancel.name"))}function b(){e(".permissions-update-button").disable();e(".button-panel-cancel-link").text(AJS.I18n.getText("close.name"))}e("#action-page-permissions-link").click(function(u){u.preventDefault();l(false)});AJS.bind("system-content-metadata.open-restrictions-dialog",function(){l(false)});e("#rte-button-restrictions").live("click",function(u){u.preventDefault();l(true)});if(n()){m.originalPermissions=Confluence.Editor.getPagePermissions()}});